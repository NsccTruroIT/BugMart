<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugMart - A QA Playground (Fixed!)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple "page" transition */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-200">

    <!-- Header & Navigation -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto max-w-6xl p-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-indigo-700 cursor-pointer" data-page="products">BugMart</h1>
            <div class="space-x-4">
                <a href="#" class="text-gray-600 hover:text-indigo-600" data-page="products">Products</a>
                <a href="#" class="text-gray-600 hover:text-indigo-600" data-page="cart">
                    Cart (<span id="cart-count">0</span>)
                </a>
                <a href="#" class="text-gray-600 hover:text-indigo-600" data-page="profile">Profile</a>
                <a href="#" class="text-gray-600 hover:text-indigo-600" id="login-logout-link" data-page="login">Login</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-root" class="container mx-auto max-w-6xl p-4 md:p-8">

        <!-- Login Page -->
        <section id="page-login" class="page bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Hint: test">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Hint: pass">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700">
                    Login
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </section>

        <!-- Product Page -->
        <section id="page-products" class="page">
            <h2 class="text-2xl font-bold mb-6">Products</h2>
            <div id="product-list" class="grid md:grid-cols-3 gap-6">
                <!-- Products will be injected here by JS -->
            </div>
        </section>

        <!-- Cart Page -->
        <section id="page-cart" class="page">
            <h2 class="text-2xl font-bold mb-6">Your Cart</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div id="cart-items" class="space-y-4">
                    <!-- Cart items will be injected here by JS -->
                </div>
                <hr class="my-6">
                <!-- Totals -->
                <div class="space-y-3">
                    <div class="flex justify-between text-lg">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg">
                        <span>Tax (10%):</span>
                        <span id="cart-tax">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg">
                        <span>Shipping:</span>
                        <span id="cart-shipping">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg text-green-600">
                        <span>Discount:</span>
                        <span id="cart-discount">-$0.00</span>
                    </div>
                    <div class="flex justify-between text-2xl font-bold mt-4 pt-4 border-t">
                        <span>TOTAL:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                </div>
                <!-- Discount Code -->
                <div class="mt-6 flex">
                    <input type="text" id="discount-code" class="block w-full rounded-l-md border-gray-300 shadow-sm p-2 border" placeholder="Discount Code (e.g., SAVE10)">
                    <button id="apply-discount-btn" class="bg-gray-700 text-white p-2 rounded-r-lg font-bold hover:bg-gray-800">Apply</button>
                </div>
                <p id="discount-message" class="text-sm mt-2"></p>
            </div>
        </section>

        <!-- Profile Page -->
        <section id="page-profile" class="page">
            <h2 class="text-2xl font-bold mb-6">Your Profile</h2>
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto space-y-4">
                <div>
                    <span class="font-semibold">Username:</span>
                    <span id="profile-username"></span>
                </div>
                <div>
                    <label for="shipping-tier" class="block text-sm font-medium text-gray-700">Shipping Tier</label>
                    <select id="shipping-tier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        <option value="standard">Standard ($15.00)</option>
                        <option value="premium">Premium (Free Shipping)</option>
                    </select>
                </div>
                <button id="update-profile-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700">
                    Update Profile
                </button>
                <p id="profile-message" class="text-green-600 text-sm text-center"></p>
            </div>
        </section>

    </main>
    
    <!-- 
    ==================================================
    == ALL BUGS FROM THE GUIDE ARE NOW FIXED ==
    ==================================================
    -->

    <script>
        // --- APPLICATION STATE ---
        const state = {
            currentUser: null, // Holds the logged-in user object
            products: [
                { id: 1, name: 'Flux Capacitor', price: 100.00, onSale: false, salePrice: null, image: 'https://placehold.co/400x300/6366f1/white?text=Flux+Capacitor' },
                { id: 2, name: 'Quantum Q-Tips', price: 10.00, onSale: true, salePrice: 5.00, image: 'https://placehold.co/400x300/10b981/white?text=Quantum+Q-Tips' },
                { id: 3, name: 'Neural Net', price: 45.00, onSale: false, salePrice: null, image: 'https://placehold.co/400x300/f59e0b/white?text=Neural+Net' }
            ],
            cart: [], // Array of product objects
            currentDiscount: 0 // 0.10 for 10%
        };

        // --- GLOBAL ELEMENTS ---
        const appRoot = document.getElementById('app-root');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('nav [data-page]');
        const cartCountEl = document.getElementById('cart-count');
        const loginLogoutLink = document.getElementById('login-logout-link');

        // --- NAVIGATION ---
        
        /**
         * Simple SPA router. Hides all pages, shows the one requested.
         */
        function navigateTo(pageId) {
            // Hide all pages
            pages.forEach(page => page.classList.remove('active'));
            // Show the requested page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.error(`Page not found: ${pageId}`);
                document.getElementById('page-products').classList.add('active');
            }
            
            // Re-render content for dynamic pages
            if (pageId === 'products') renderProducts();
            if (pageId === 'cart') renderCart();
            if (pageId === 'profile') renderProfile();
            
            // Handle auth-wall
            if (pageId === 'cart' || pageId === 'profile') {
                if (!state.currentUser) {
                    navigateTo('login');
                    document.getElementById('login-error').textContent = 'You must be logged in to view this page.';
                    document.getElementById('login-error').classList.remove('hidden');
                }
            }
        }

        /**
         * Attaches click handlers to all nav links.
         */
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.getAttribute('data-page');
                    if (pageId === 'login' && state.currentUser) {
                        // Handle logout
                        state.currentUser = null;
                        state.cart = []; // Clear cart on logout
                        state.currentDiscount = 0;
                        updateCartIcon();
                        loginLogoutLink.textContent = 'Login';
                        navigateTo('login');
                    } else {
                        navigateTo(pageId);
                    }
                });
            });
        }
        
        // --- PAGE RENDERING FUNCTIONS ---
        
        /**
         * Renders the product list on the Products page.
         */
        function renderProducts() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = ''; // Clear list
            
            state.products.forEach(product => {
                const priceHtml = product.onSale
                    ? `<span class="text-lg font-bold text-red-600">$${product.salePrice.toFixed(2)}</span>
                       <span class="text-sm text-gray-500 line-through ml-2">$${product.price.toFixed(2)}</span>`
                    : `<span class="text-lg font-bold text-gray-800">$${product.price.toFixed(2)}</span>`;
                
                productList.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-xl font-bold">${product.name}</h3>
                            <div class="my-2">${priceHtml}</div>
                            <button class="add-to-cart-btn w-full bg-indigo-600 text-white p-2 rounded-lg font-bold hover:bg-indigo-700" data-product-id="${product.id}">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add event listeners to new buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', handleAddToCart);
            });
        }

        /**
         * Renders the cart contents and calculates totals.
         */
        function renderCart() {
            const cartItemsEl = document.getElementById('cart-items');
            cartItemsEl.innerHTML = '';
            
            if (state.cart.length === 0) {
                cartItemsEl.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
                calculateTotals(); 
                return;
            }

            state.cart.forEach(item => {
                // Use a unique identifier for each cart item, e.g., index
                // For this simple app, we'll just use product ID for removal
                cartItemsEl.innerHTML += `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${item.name}</h4>
                            <p class="text-sm text-gray-600">$${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">$${item.price.toFixed(2)}</span>
                            <!-- FEATURE: Add Remove Button -->
                            <button class="remove-from-cart-btn text-red-500 hover:text-red-700 font-bold text-lg" data-product-id="${item.id}" title="Remove item">
                                &times;
                            </button>
                        </div>
                    </div>
                `;
            });

            // Add listeners for remove buttons
            cartItemsEl.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveFromCart);
            });
            
            calculateTotals(); 
        }
        
        /**
         * Renders the profile page.
         */
        function renderProfile() {
            if (!state.currentUser) return; // Should be caught by router, but good practice
            
            // FIX 1: Read username from state.currentUser.username
            document.getElementById('profile-username').textContent = state.currentUser.username;
            
            document.getElementById('shipping-tier').value = state.currentUser.shippingTier;
        }

        // --- LOGIC & EVENT HANDLERS ---
        
        /**
         * Handles the login form submission.
         */
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            // FIX 7: Add validation for empty fields
            if (!username || !password) {
                errorEl.textContent = 'Please enter both username and password.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (username === 'test' && password === 'pass') {
                state.currentUser = {
                    username: username,
                    shippingTier: 'standard' // Default shipping
                };
                loginLogoutLink.textContent = 'Logout';
                errorEl.classList.add('hidden');
                navigateTo('products');
            } else {
                errorEl.textContent = 'Invalid username or password.';
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * Handles adding an item to the cart.
         * This function is no longer commented out and replaces the broken hard-coded listener.
         */
        function handleAddToCart(e) {
            if (!state.currentUser) {
                navigateTo('login');
                document.getElementById('login-error').textContent = 'You must be logged in to add items.';
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }
            
            // FIX 4: This listener now works for *all* buttons
            const productId = parseInt(e.currentTarget.getAttribute('data-product-id'));
            
            const product = state.products.find(p => p.id === productId);
            if (!product) return; // Product not found

            // Create a copy to add to the cart
            const itemToAdd = { ...product };

            // FIX 8: Check if it's on sale and use the sale price
            if (itemToAdd.onSale && itemToAdd.salePrice) {
                itemToAdd.price = itemToAdd.salePrice;
            }

            state.cart.push(itemToAdd);

            // FIX 3: Update the cart icon immediately!
            updateCartIcon();
        }

        /**
         * Handles removing an item from the cart.
         */
        function handleRemoveFromCart(e) {
            const productId = parseInt(e.currentTarget.getAttribute('data-product-id'));
            
            // Find the *first* instance of this product in the cart and remove it
            // This handles duplicates one by one
            const itemIndex = state.cart.findIndex(item => item.id === productId);
            
            if (itemIndex > -1) {
                state.cart.splice(itemIndex, 1);
            }
            
            // Re-render the cart (which recalculates totals)
            renderCart();
            // Also update the header icon
            updateCartIcon();
        }

        /**
         * Calculates all totals in the cart.
         */
        function calculateTotals() {
            let subtotal = 0;
            state.cart.forEach(item => {
                // FIX 8 (Continued): This now reads the correct (sale) price
                subtotal += item.price;
            });
            
            const tax = subtotal * 0.10;
            
            // FIX 2: Shipping cost now correctly reads from the user's state
            let shippingCost = (state.currentUser && state.currentUser.shippingTier === 'premium') ? 0.00 : 15.00;
            
            // If cart is empty, shipping is 0
            if (state.cart.length === 0) {
                shippingCost = 0.00;
            }
            
            let total = subtotal + tax + shippingCost;
            
            // FIX 5: Discount is applied to *subtotal*, not *total*.
            let discountAmount = subtotal * state.currentDiscount;
            total -= discountAmount;
            
            document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cart-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('cart-shipping').textContent = `$${shippingCost.toFixed(2)}`;
            document.getElementById('cart-discount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
        }

        /**
         * Handles the "Apply Discount" button.
         */
        function handleApplyDiscount() {
            const code = document.getElementById('discount-code').value;
            const messageEl = document.getElementById('discount-message');
            
            // FIX 6: Removed the "subtotal > 50" requirement for 'SAVE10'
            if (code === 'SAVE10' && state.cart.length > 0) {
                messageEl.textContent = '10% discount applied!';
                messageEl.className = 'text-green-600 text-sm mt-2';
                state.currentDiscount = 0.10; // Apply 10% discount
            } else {
                messageEl.textContent = 'Discount code not valid for this order.';
                messageEl.className = 'text-red-500 text-sm mt-2';
                state.currentDiscount = 0; // Apply 0% discount
            }
            // Recalculate totals with the new discount
            calculateTotals();
        }
        
        /**
         * Handles the "Update Profile" button.
         */
        function handleUpdateProfile() {
            if (!state.currentUser) return;
            const tier = document.getElementById('shipping-tier').value;
            state.currentUser.shippingTier = tier;
            
            // FIX 1 (Continued): This now just updates the username text
            // which was already set correctly by renderProfile
            document.getElementById('profile-username').textContent = state.currentUser.username;
            
            const messageEl = document.getElementById('profile-message');
            messageEl.textContent = 'Profile updated successfully!';
            setTimeout(() => messageEl.textContent = '', 2000);

            // If we update shipping, we should recalculate the cart
            // but the user isn't on that page. The cart will be correct
            // next time they visit it, since renderCart() calls calculateTotals().
        }

        /**
         * Updates the cart count in the header.
         */
        function updateCartIcon() {
            cartCountEl.textContent = state.cart.length;
        }


        // --- APP INITIALIZATION ---
        function init() {
            setupNavigation();
            // Add listeners for forms/buttons that are always visible
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('update-profile-btn').addEventListener('click', handleUpdateProfile);
            document.getElementById('apply-discount-btn').addEventListener('click', handleApplyDiscount);
            
            // Start on the login page
            navigateTo('login');
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
