<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugMart - A QA Playground (Fixed)</title>
    <!-- Load Tailwind CSS - FIXED LINK -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use the Inter font, which is clean and modern */
        body { font-family: 'Inter', sans-serif; }
        
        /* Simple "page" transition animation */
        .page { 
            display: none; /* Hide pages by default */
            animation: fadeIn 0.3s;
            width: 100%; /* Ensure pages take full width of their container */
        }
        .page.active { 
            display: block; /* Show the active page */
        }
        
        /* Fade-in and slight upward move animation */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<!-- UPDATED STYLES: Changed bg color and added min-h-screen to ensure footer (if any) sticks to bottom -->
<body class="bg-slate-100 min-h-screen">

    <!-- Header & Navigation - UPDATED STYLES: New color (sky), sticky top for usability -->
    <nav class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto max-w-6xl p-4 flex justify-between items-center">
            <!-- UPDATED STYLES: Changed to sky blue -->
            <h1 class="text-3xl font-bold text-sky-600 cursor-pointer" data-page="products">BugMart</h1>
            <!-- UPDATED STYLES: Responsive spacing for nav links -->
            <div class="space-x-2 md:space-x-4">
                <a href="#" class="text-gray-600 hover:text-sky-600" data-page="products">Products</a>
                <a href="#" class="text-gray-600 hover:text-sky-600" data-page="cart">
                    Cart (<span id="cart-count">0</span>)
                </a>
                <a href="#" class="text-gray-600 hover:text-sky-600" data-page="profile">Profile</a>
                <a href="#" class="text-gray-600 hover:text-sky-600" id="login-logout-link" data-page="login">Login</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area - UPDATED STYLES: Centered content for login/profile, full-width for products/cart -->
    <main id="app-root" class="container mx-auto max-w-6xl p-4 md:p-8 flex flex-col items-center justify-start min-h-[calc(100vh-80px)]">

        <!-- Login Page -->
        <section id="page-login" class="page bg-white p-8 rounded-lg shadow-lg max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Hint: test">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Hint: pass">
                </div>
                <!-- UPDATED STYLES: New color (sky) and transition -->
                <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-lg font-bold hover:bg-sky-700 transition-colors">
                    Login
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </section>

        <!-- Product Page -->
        <section id="page-products" class="page">
            <h2 class="text-3xl font-bold mb-6 text-slate-800">Products</h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Products will be injected here by JS -->
            </div>
        </section>

        <!-- Cart Page -->
        <section id="page-cart" class="page">
            <h2 class="text-3xl font-bold mb-6 text-slate-800">Your Cart</h2>
            <!-- UPDATED STYLES: Set max-width for consistency on large screens -->
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl mx-auto">
                <div id="cart-items" class="space-y-4">
                    <!-- Cart items will be injected here by JS -->
                </div>
                <hr class="my-6">
                <!-- Totals -->
                <div class="space-y-3">
                    <div class="flex justify-between text-lg">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg">
                        <span>Tax (10%):</span>
                        <span id="cart-tax">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg">
                        <span>Shipping:</span>
                        <span id="cart-shipping">$0.00</span>
                    </div>
                    <!-- ADDED: Discount line item for clarity (Fix for Bug 5) -->
                    <div class="flex justify-between text-lg text-green-600">
                        <span>Discount:</span>
                        <span id="cart-discount">-$0.00</span>
                    </div>
                    <div class="flex justify-between text-2xl font-bold mt-4 pt-4 border-t">
                        <span>TOTAL:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                </div>
                <!-- Discount Code -->
                <div class="mt-6 flex">
                    <input type="text" id="discount-code" class="block w-full rounded-l-md border-gray-300 shadow-sm p-2 border" placeholder="Discount Code (e.g., SAVE10)">
                    <button id="apply-discount-btn" class="bg-gray-700 text-white p-2 rounded-r-lg font-bold hover:bg-gray-800">Apply</button>
                </div>
                <p id="discount-message" class="text-sm mt-2"></p>
            </div>
        </section>

        <!-- Profile Page - UPDATED with Tabs and New Fields -->
        <section id="page-profile" class="page">
            <h2 class="text-3xl font-bold mb-6 text-slate-800">Your Profile</h2>
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg w-full space-y-4">
                
                <!-- Tab Buttons -->
                <div class="flex border-b">
                    <button id="tab-btn-details" class="profile-tab-btn py-2 px-4 text-sky-600 border-b-2 border-sky-600 font-semibold">User Details</button>
                    <button id="tab-btn-settings" class="profile-tab-btn py-2 px-4 text-gray-500 hover:text-gray-700">Settings</button>
                </div>

                <!-- Tab Content: User Details -->
                <div id="tab-content-details" class="profile-tab-content space-y-4">
                    <div class="text-lg">
                        <span class="font-semibold">Username:</span>
                        <span id="profile-username"></span> <!-- This is read-only -->
                    </div>
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="profile-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="profile-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="profile-address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="profile-address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="profile-location" class="block text-sm font-medium text-gray-700">Location (City, State)</label>
                        <input type="text" id="profile-location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>

                <!-- Tab Content: Settings (Shipping) -->
                <div id="tab-content-settings" class="profile-tab-content space-y-4 hidden">
                    <div>
                        <label for="shipping-tier" class="block text-sm font-medium text-gray-700">Shipping Tier</label>
                        <select id="shipping-tier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="standard">Standard ($15.00)</option>
                            <option value="premium">Premium (Free Shipping)</option>
                        </select>
                    </div>
                </div>

                <!-- Shared Button and Message -->
                <button id="update-profile-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition-colors">
                    Update Profile
                </button>
                <p id="profile-message" class="text-green-600 text-sm text-center"></p>
            </div>
        </section>

    </main>
    
    <script>
        // --- APPLICATION STATE ---
        // This is the "single source of truth".
        const state = {
            currentUser: null, // Holds the logged-in user object
            products: [
                // FIXED IMAGE URLS
                { id: 1, name: 'Flux Capacitor', price: 100.00, onSale: false, salePrice: null, image: 'https://placehold.co/400x300/38bdf8/white?text=Flux+Capacitor' },
                { id: 2, name: 'Quantum Q-Tips', price: 10.00, onSale: true, salePrice: 5.00, image: 'https://placehold.co/400x300/10b981/white?text=Quantum+Q-Tips' },
                { id: 3, name: 'Neural Net', price: 45.00, onSale: false, salePrice: null, image: 'https://placehold.co/400x300/f59e0b/white?text=Neural+Net' }
            ],
            cart: [], // Array of product objects
            currentDiscount: 0 // Holds the discount percentage, e.g., 0.10
        };

        // --- GLOBAL ELEMENTS ---
        const appRoot = document.getElementById('app-root');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('nav [data-page]');
        const cartCountEl = document.getElementById('cart-count');
        const loginLogoutLink = document.getElementById('login-logout-link');

        // --- NAVIGATION ---
        
        /**
         * Simple SPA router. Hides all pages, shows the one requested.
         */
        function navigateTo(pageId) {
            // Handle auth-wall *before* navigating
            // FIX: TC-LOGIN-003 & TC-BUG-006
            if (pageId === 'cart' || pageId === 'profile') {
                if (!state.currentUser) {
                    // Redirect to login
                    navigateTo('login');
                    // Display error message
                    const errorEl = document.getElementById('login-error');
                    errorEl.textContent = 'You must be logged in to view this page.';
                    errorEl.classList.remove('hidden');
                    return; // Stop navigation
                }
            }
            
            // Hide all pages
            pages.forEach(page => page.classList.remove('active'));
            
            // Show the requested page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.error(`Page not found: ${pageId}`);
                document.getElementById('page-products').classList.add('active');
            }
            
            // Re-render content for dynamic pages
            if (pageId === 'products') renderProducts();
            if (pageId === 'cart') renderCart();
            if (pageId === 'profile') renderProfile();
        }

        /**
         * Attaches click handlers to all nav links.
         */
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.getAttribute('data-page');
                    
                    if (pageId === 'login' && state.currentUser) {
                        // Handle logout
                        state.currentUser = null;
                        
                        // FIX: TC-BUG-007 - Cart SHOULD persist. Do NOT clear state.cart.
                        // The original code had `state.cart = [];` which was a bug.
                        
                        state.currentDiscount = 0; // Clear discount
                        updateCartIcon(); // Update count (will be 0 if cart is cleared, or persisted count if not)
                        loginLogoutLink.textContent = 'Login';
                        navigateTo('login');
                    } else {
                        navigateTo(pageId);
                    }
                });
            });
        }
        
        // --- PAGE RENDERING FUNCTIONS ---
        
        /**
         * Renders the product list on the Products page.
         */
        function renderProducts() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = ''; // Clear list
            
            state.products.forEach(product => {
                const priceHtml = product.onSale
                    ? `<span class="text-lg font-bold text-red-600">$${product.salePrice.toFixed(2)}</span>
                       <span class="text-sm text-gray-500 line-through ml-2">$${product.price.toFixed(2)}</span>`
                    : `<span class="text-lg font-bold text-gray-800">$${product.price.toFixed(2)}</span>`;
                
                // UPDATED STYLES: Added transition and hover effects
                productList.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-xl font-bold">${product.name}</h3>
                            <div class="my-2">${priceHtml}</div>
                            <!-- UPDATED STYLES: New color (sky) -->
                            <button class="add-to-cart-btn w-full bg-sky-600 text-white p-2 rounded-lg font-bold hover:bg-sky-700 transition-colors" data-product-id="${product.id}">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add event listeners to new buttons
            // This setup is correct and works for all buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', handleAddToCart);
            });
        }

        /**
         * Renders the cart contents and calculates totals.
         */
        function renderCart() {
            // FIX: TC-BUG-002 (Bug 3) - Update cart icon *every time* cart is rendered
            updateCartIcon();
            
            const cartItemsEl = document.getElementById('cart-items');
            cartItemsEl.innerHTML = '';
            
            if (state.cart.length === 0) {
                cartItemsEl.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
                calculateTotals(); // Calculate totals (will be all 0)
                return;
            }

            state.cart.forEach((item, index) => {
                // FIX: TC-BUG-005 - Add a remove button with a unique identifier (index)
                cartItemsEl.innerHTML += `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${item.name}</h4>
                            <p class="text-sm text-gray-600">$${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">$${item.price.toFixed(2)}</span>
                            <!-- This is the new "Remove" button -->
                            <button class="remove-from-cart-btn text-red-500 hover:text-red-700 font-bold text-2xl" data-cart-index="${index}" title="Remove item">
                                &times;
                            </button>
                        </div>
                    </div>
                `;
            });

            // FIX: TC-BUG-005 (Continued) - Add event listeners for new remove buttons
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveFromCart);
            });
            
            calculateTotals(); // Recalculate totals
        }
        
        /**
         * Renders the profile page.
         */
        function renderProfile() {
            if (!state.currentUser) return; 
            
            // FIX: TC-BUG-001 (Bug 1) - Read from state.currentUser.username on render
            document.getElementById('profile-username').textContent = state.currentUser.username;
            
            // UPDATED: Populate all new fields
            document.getElementById('profile-name').value = state.currentUser.name;
            document.getElementById('profile-email').value = state.currentUser.email;
            document.getElementById('profile-address').value = state.currentUser.address;
            document.getElementById('profile-location').value = state.currentUser.location;
            
            document.getElementById('shipping-tier').value = state.currentUser.shippingTier;

            // Reset tabs to default view
            document.getElementById('tab-content-details').classList.remove('hidden');
            document.getElementById('tab-content-settings').classList.add('hidden');
            document.getElementById('tab-btn-details').classList.add('text-sky-600', 'border-sky-600');
            document.getElementById('tab-btn-details').classList.remove('text-gray-500', 'hover:text-gray-700');
            document.getElementById('tab-btn-settings').classList.add('text-gray-500', 'hover:text-gray-700');
            document.getElementById('tab-btn-settings').classList.remove('text-sky-600', 'border-sky-600');
        }

        // --- LOGIC & EVENT HANDLERS ---
        
        /**
         * Handles the login form submission.
         */
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            // FIX: TC-LOGIN-002 (Bug 7) - Add validation for empty fields
            if (!username || !password) {
                errorEl.textContent = 'Please enter both username and password.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (username === 'test' && password === 'pass') {
                // UPDATED: Add new fields to the user state on login
                state.currentUser = {
                    username: username,
                    shippingTier: 'standard', // Default shipping
                    name: "Test User",
                    email: "test@example.com",
                    address: "123 Bug St",
                    location: "Testville, QA"
                };
                loginLogoutLink.textContent = 'Logout';
                errorEl.classList.add('hidden');
                navigateTo('products');
            } else {
                // FIX: TC-LOGIN-002 - Ensure error message is correct
                errorEl.textContent = 'Invalid username or password.';
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * Handles adding an item to the cart.
         */
        function handleAddToCart(e) {
            if (!state.currentUser) {
                navigateTo('login');
                document.getElementById('login-error').textContent = 'You must be logged in to add items.';
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }
            
            // FIX: TC-BUG-003 (Bug 4) - This now works for ALL buttons, not just one.
            const productId = parseInt(e.currentTarget.getAttribute('data-product-id'));
            
            const product = state.products.find(p => p.id === productId);
            if (!product) return; // Product not found

            // Create a copy to add to the cart
            const itemToAdd = { ...product };

            // FIX: TC-BUG-003 (Bug 8) - Check if it's on sale and use the salePrice
            if (itemToAdd.onSale && itemToAdd.salePrice) {
                itemToAdd.price = itemToAdd.salePrice;
            }

            state.cart.push(itemToAdd);

            // FIX: TC-BUG-002 (Bug 3) - Update the cart icon immediately!
            updateCartIcon();
        }

        /**
         * FIX: TC-BUG-005 - New function to remove item from cart
         */
        function handleRemoveFromCart(e) {
            const cartIndex = parseInt(e.currentTarget.getAttribute('data-cart-index'));
            
            // Check if the index is valid
            if (cartIndex > -1 && cartIndex < state.cart.length) {
                state.cart.splice(cartIndex, 1); // Remove 1 item at the found index
            }
            
            // Re-render the cart to show removal and update totals
            renderCart();
        }


        /**
         * Calculates all totals in the cart.
         */
        function calculateTotals() {
            let subtotal = 0;
            state.cart.forEach(item => {
                // FIX: TC-BUG-003 (Bug 8) - This now correctly reads the price
                subtotal += item.price;
            });
            
            const tax = subtotal * 0.10;
            
            // FIX: TC-BUG-004 (Bug 2) - Shipping cost now correctly reads from the user's state
            let shippingCost = 15.00; // Default
            if (state.currentUser && state.currentUser.shippingTier === 'premium') {
                shippingCost = 0.00;
            }
            if (state.cart.length === 0) {
                shippingCost = 0.00; // No shipping on empty cart
            }
            
            // FIX: (Bug 5) - Discount based on *subtotal*, not total
            let discountAmount = subtotal * state.currentDiscount;
            
            let total = subtotal + tax + shippingCost - discountAmount;
            
            // Update all the text fields
            document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cart-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('cart-shipping').textContent = `$${shippingCost.toFixed(2)}`;
            document.getElementById('cart-discount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
        }

        /**
         * Handles the "Apply Discount" button.
         */
        function handleApplyDiscount() {
            const code = document.getElementById('discount-code').value;
            const messageEl = document.getElementById('discount-message');
            
            // FIX: (Bug 6) - Removed `subtotal > 50` condition.
            if (code === 'SAVE10' && state.cart.length > 0) {
                messageEl.textContent = '10% discount applied!';
                messageEl.className = 'text-green-600 text-sm mt-2';
                state.currentDiscount = 0.10; // Set discount state
            } else {
                // FIX: TC-DISCOUNT-001 - Ensure error message is correct
                messageEl.textContent = 'Discount code not valid for this order.';
                messageEl.className = 'text-red-500 text-sm mt-2';
                state.currentDiscount = 0; // Reset discount
            }

            // Recalculate totals with the new discount
            calculateTotals();
        }
        
        /**
         * Handles the "Update Profile" button.
         */
        function handleUpdateProfile() {
            if (!state.currentUser) return; // Safety check
            
            // UPDATED: Read from all fields in the state
            state.currentUser.shippingTier = document.getElementById('shipping-tier').value;
            state.currentUser.name = document.getElementById('profile-name').value;
            state.currentUser.email = document.getElementById('profile-email').value;
            state.currentUser.address = document.getElementById('profile-address').value;
            state.currentUser.location = document.getElementById('profile-location').value;
            
            // FIX: TC-BUG-001 - Set username text when updating (and on load)
            document.getElementById('profile-username').textContent = state.currentUser.username;
            
            const messageEl = document.getElementById('profile-message');
            messageEl.textContent = 'Profile updated successfully!';
            setTimeout(() => messageEl.textContent = '', 2000);
        }

        /**
         * Updates the cart count in the header.
         */
        function updateCartIcon() {
            cartCountEl.textContent = state.cart.length;
        }

        /**
         * UPDATED: Adds click handlers for profile tabs
         */
        function setupProfileTabs() {
            const tabBtnDetails = document.getElementById('tab-btn-details');
            const tabBtnSettings = document.getElementById('tab-btn-settings');
            const tabContentDetails = document.getElementById('tab-content-details');
            const tabContentSettings = document.getElementById('tab-content-settings');

            tabBtnDetails.addEventListener('click', () => {
                tabContentDetails.classList.remove('hidden');
                tabContentSettings.classList.add('hidden');

                tabBtnDetails.classList.add('text-sky-600', 'border-sky-600');
                tabBtnDetails.classList.remove('text-gray-500', 'hover:text-gray-700');
                tabBtnSettings.classList.add('text-gray-500', 'hover:text-gray-700');
                tabBtnSettings.classList.remove('text-sky-600', 'border-sky-600');
            });

            tabBtnSettings.addEventListener('click', () => {
                tabContentDetails.classList.add('hidden');
                tabContentSettings.classList.remove('hidden');

                tabBtnDetails.classList.remove('text-sky-600', 'border-sky-600');
                tabBtnDetails.classList.add('text-gray-500', 'hover:text-gray-700');
                tabBtnSettings.classList.remove('text-gray-500', 'hover:text-gray-700');
                tabBtnSettings.classList.add('text-sky-600', 'border-sky-600');
            });
        }


        // --- APP INITIALIZATION ---
        function init() {
            setupNavigation();
            setupProfileTabs(); // ADDED: Initialize profile tab logic
            // Add listeners for forms/buttons that are always visible
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('update-profile-btn').addEventListener('click', handleUpdateProfile);
            document.getElementById('apply-discount-btn').addEventListener('click', handleApplyDiscount);
            
            // Start on the login page
            navigateTo('login');
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
